trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Deploy
  displayName: "ğŸš€ Deploy para VPS"
  jobs:
  - job: DeployJob
    displayName: "ğŸ”§ Executando deploy remoto"
    steps:

    # ğŸ”µ Define versÃ£o do Python no agente da Microsoft
    - task: UsePythonVersion@0
      displayName: "ğŸ Definindo Python 3.12"
      inputs:
        versionSpec: '3.12'
        addToPath: true

    # ğŸ”µ Deploy via SSH
    - task: SSH@0
      displayName: "ğŸ” Conectando via SSH e executando deploy"
      inputs:
        sshEndpoint: 'praxis-vps-ssh'
        runOptions: 'commands'
        commands: |
          set -e

          echo "=============================="
          echo "ğŸš€ INICIANDO DEPLOY PRAXIS"
          echo "=============================="

          echo "UsuÃ¡rio:"
          id

          set -e

          echo "UsuÃ¡rio:"
          id

          echo "HOME:"
          echo $HOME

          echo "Listando HOME:"
          ls -la $HOME

          echo "Listando diretÃ³rio do projeto:"
          ls -la /home/praxis/praxis_crm

          echo "ğŸ”„ Atualizando cÃ³digo..."
          git -C /home/praxis/praxis_crm fetch --all
          git -C /home/praxis/praxis_crm reset --hard origin/master

          echo "ğŸ Ativando ambiente virtual..."
          source venv/bin/activate

          echo "ğŸ“¦ Instalando dependÃªncias..."
          pip install --upgrade pip
          pip install -r requirements.txt

          echo "ğŸ—„ Aplicando migrations..."
          python manage.py migrate --noinput

          echo "ğŸ—‚ Coletando estÃ¡ticos..."
          python manage.py collectstatic --noinput

          echo "ğŸ” Reiniciando serviÃ§o..."
          sudo systemctl restart praxis

          echo "âœ… DEPLOY FINALIZADO"
        readyTimeout: '20000'
