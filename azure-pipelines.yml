trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Deploy
  displayName: "ğŸš€ Deploy para VPS"
  jobs:
  - job: DeployJob
    displayName: "ğŸ”§ Executando deploy remoto"
    steps:

    # ğŸ”µ Define versÃ£o do Python no agente (nÃ£o afeta a VPS, mas mantÃ©m padrÃ£o)
    - task: UsePythonVersion@0
      displayName: "ğŸ Definindo Python 3.12"
      inputs:
        versionSpec: '3.12'
        addToPath: true

    # ğŸ”µ Deploy via SSH
    - task: SSH@0
      displayName: "ğŸ” Conectando via SSH e executando deploy"
      inputs:
        sshEndpoint: 'praxis-vps-ssh'
        runOptions: 'commands'
        commands: |
          set -e

          echo "=============================="
          echo "ğŸš€ INICIANDO DEPLOY PRAXIS"
          echo "=============================="

          echo "ğŸ‘¤ UsuÃ¡rio atual:"
          id

          echo "ğŸ“‚ Verificando diretÃ³rio do projeto..."
          ls -la /home/praxis/praxis_crm

          echo "ğŸ”„ Atualizando cÃ³digo..."
          git -C /home/praxis/praxis_crm fetch --all
          git -C /home/praxis/praxis_crm reset --hard origin/master

          echo "â¬†ï¸ Atualizando pip..."
          /home/praxis/praxis_crm/venv/bin/pip install --upgrade pip

          echo "ğŸ“¦ Instalando dependÃªncias..."
          /home/praxis/praxis_crm/venv/bin/pip install -r /home/praxis/praxis_crm/requirements.txt

          echo "ğŸ—„ Aplicando migrations..."
          /home/praxis/praxis_crm/venv/bin/python /home/praxis/praxis_crm/manage.py migrate --noinput

          echo "ğŸ—‚ Coletando estÃ¡ticos..."
          /home/praxis/praxis_crm/venv/bin/python /home/praxis/praxis_crm/manage.py collectstatic --noinput

          echo "ğŸ” Reiniciando serviÃ§o..."
          sudo systemctl restart praxis

          echo "=============================="
          echo "âœ… DEPLOY FINALIZADO"
          echo "=============================="

        readyTimeout: '20000'
