trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Deploy
  displayName: "ğŸš€ Deploy para VPS"
  jobs:
  - job: DeployJob
    displayName: "ğŸ”§ Executando deploy remoto"
    steps:

    # ğŸ”µ Define versÃ£o do Python no agente da Microsoft
    - task: UsePythonVersion@0
      displayName: "ğŸ Definindo Python 3.12"
      inputs:
        versionSpec: '3.12'
        addToPath: true

    # ğŸ”µ Deploy via SSH
    - task: SSH@0
      displayName: "ğŸ” Conectando via SSH e executando deploy"
      inputs:
        sshEndpoint: 'praxis-vps-ssh'
        runOptions: 'commands'
        commands: |
          set -e

          echo "=============================="
          echo "ğŸš€ INICIANDO DEPLOY PRAXIS"
          echo "=============================="

          PROJECT_PATH="$HOME/praxis_crm"          
          VENV_PATH="$PROJECT_PATH/venv"

          echo "PROJECT_PATH=$PROJECT_PATH"

          echo "ğŸ‘¤ UsuÃ¡rio:"
          id

          echo "ğŸ  HOME:"
          echo $HOME

          echo "ğŸ“‚ Verificando diretÃ³rio do projeto..."
          ls -la "$PROJECT_PATH"

          echo "ğŸ”„ Atualizando cÃ³digo..."
          git -C "$PROJECT_PATH" fetch --all
          git -C "$PROJECT_PATH" reset --hard origin/master

          echo "ğŸ Verificando ambiente virtual..."

          if [ ! -d "$VENV_PATH" ]; then
            echo "Criando ambiente virtual..."
            python3 -m venv "$VENV_PATH"
          fi

          echo "â¬†ï¸ Atualizando pip..."
          "$VENV_PATH/bin/pip" install --upgrade pip

          echo "ğŸ“¦ Instalando dependÃªncias..."
          "$VENV_PATH/bin/pip" install -r "$PROJECT_PATH/requirements.txt"

          echo "ğŸ—„ Aplicando migrations..."
          "$VENV_PATH/bin/python" "$PROJECT_PATH/manage.py" migrate --noinput

          echo "ğŸ—‚ Coletando estÃ¡ticos..."
          "$VENV_PATH/bin/python" "$PROJECT_PATH/manage.py" collectstatic --noinput

          echo "ğŸ” Reiniciando serviÃ§o..."
          sudo systemctl restart praxis

          echo "=============================="
          echo "âœ… DEPLOY FINALIZADO"
          echo "=============================="

        readyTimeout: '20000'
